<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>China Housing Price Decline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { height: 90vh; }
  .legend {
      position: absolute; bottom: 80px; right: 10px;
      background: white; padding: 15px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000;
  }
  .legend-item { display:flex; align-items:center; margin:3px 0; font-size:12px; }
  .legend-color { width:20px; height:15px; margin-right:8px; border:1px solid #ddd; }
  #top10Container {
      position: absolute; bottom: 80px; left: 10px;
      background: white; padding: 12px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 220px;
      z-index: 1000; font-size: 13px; line-height: 1.4;
  }
  #top10Container h4 { margin:0 0 6px 0; font-size:14px; }
  #top10List { list-style:none; padding-left:0; margin:0; }
  #top10List li { cursor:pointer; min-width:60px; margin-bottom:4px; }
</style>
</head>
<body>

<div id="top10Container">
  <h4>Top 10 Declines</h4>
  <ol id="top10List"></ol>
  <small>Click a city to zoom and see details</small>
</div>

<div id="map"></div>

<div class="legend">
  <h4>Decline from Peak (%)</h4>
  <div class="legend-item"><div class="legend-color" style="background:#8B0000;"></div><span>+5% (New High)</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#DC143C;"></div><span>0% to +5%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#FFFFFF;"></div><span>0% to -5%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#E6F3FF;"></div><span>-5% to -10%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#87CEEB;"></div><span>-10% to -15%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#4169E1;"></div><span>-15% to -20%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#0000CD;"></div><span>-20% to -25%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#000080;"></div><span>-25% to -30%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#00008B;"></div><span>-30% to -35%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#191970;"></div><span>-35% to -40%</span></div>
  <div class="legend-item"><div class="legend-color" style="background:#000033;"></div><span>-40%+ (Worst)</span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
const map = L.map('map').setView([35,105],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'© OpenStreetMap contributors'
}).addTo(map);

function getColor(val) {
    if(val >= 5) return '#8B0000';      // 5% 及以上 (深红 - 新高)
    if(val >= 0) return '#DC143C';      // 0% 到 5% (红色 - 接近峰值)
    if(val > -5) return '#FFFFFF';      // 0% 到 -5% (白色 - 轻微下跌)
    if(val > -10) return '#E6F3FF';     // -5% 到 -10% (极浅蓝)
    if(val > -15) return '#87CEEB';     // -10% 到 -15% (天蓝)
    if(val > -20) return '#4169E1';     // -15% 到 -20% (皇家蓝)
    if(val > -25) return '#0000CD';     // -20% 到 -25% (中蓝)
    if(val > -30) return '#000080';     // -25% 到 -30% (海军蓝)
    if(val > -35) return '#00008B';     // -30% 到 -35% (深蓝)
    if(val > -40) return '#191970';     // -35% 到 -40% (午夜蓝)
    return '#000033';                   // -40% 及以下 (极深蓝)
}

function style(feature) {
    return {
        fillColor: getColor(feature.properties.decline_from_peak),
        weight:0.3,
        color:'gray',
        fillOpacity:0.9
    };
}

function onEachFeature(feature, layer){
    const p = feature.properties;
    const decline = p.decline_from_peak;
    layer.bindPopup(`
        <div style="font-family:Arial; line-height:1.4;">
            <h4 style="margin:0 0 10px 0;">${p.city}</h4>
            <strong>Province:</strong> ${p.pr_name}<br/><br/>
            <strong>Peak Year:</strong> ${p.peak_year}<br/>
            <strong>Peak Price:</strong> ¥${Math.round(p.peak_price).toLocaleString()}/m²<br/>
            <strong>Decline:</strong> ${decline.toFixed(1)}% until Jul 2025
        </div>
    `,{maxWidth:300});
}

// 异步加载 GeoJSON 文件
fetch('peak_decline_boundaries_simplified.geojson')
    .then(response => response.json())
    .then(geojsonData => {
        // 首先计算所有城市的跌幅排名
        let allCities = geojsonData.features
            .map(f => ({'f':f, 'drop': f.properties.decline_from_peak}))
            .sort((a,b)=>a.drop-b.drop);
        
        // 创建排名映射
        const cityRankings = {};
        allCities.forEach((city, index) => {
            cityRankings[city.f.properties.city] = index + 1;
        });

        // 重新定义 onEachFeature 函数，使用已计算的排名
        function onEachFeatureWithRank(feature, layer){
            const p = feature.properties;
            const decline = p.decline_from_peak;
            const rank = cityRankings[p.city] || 'N/A';
            
            // 根据涨跌情况显示不同的文本
            let changeText, rankText;
            if (decline >= 0) {
                changeText = `<strong>Gain from Peak:</strong> +${decline.toFixed(1)}% until Jul 2025`;
                rankText = `<strong>Performance Rank:</strong> #${rank} nationwide (Best performers)`;
            } else {
                changeText = `<strong>Decline from Peak:</strong> ${decline.toFixed(1)}% until Jul 2025`;
                rankText = `<strong>Decline Rank:</strong> #${rank} nationwide (Worst performers)`;
            }
            
            layer.bindPopup(`
                <div style="font-family:Arial; line-height:1.4;">
                    <h4 style="margin:0 0 10px 0;">${p.city}</h4>
                    <strong>Province:</strong> ${p.pr_name}<br/><br/>
                    <strong>Peak Year:</strong> ${p.peak_year}<br/>
                    <strong>Peak Price:</strong> ¥${Math.round(p.peak_price).toLocaleString()}/m²<br/>
                    ${changeText}<br/>
                    ${rankText}
                </div>
            `,{maxWidth:300});
        }

        // 创建地图层，使用包含排名的函数
        const geoLayer = L.geoJSON(geojsonData, {
            style: style,
            onEachFeature: onEachFeatureWithRank
        }).addTo(map);

        map.fitBounds(geoLayer.getBounds(), {padding:[20,20]});

        // Top10 declines
        let top10Items = allCities.slice(0,10);

        const ol = document.getElementById("top10List");
        ol.innerHTML = "";
        top10Items.forEach((it,i)=>{
            const li = document.createElement("li");
            li.textContent = `${i+1}: ${it.f.properties.city} (${it.drop.toFixed(1)}%)`;
            li.addEventListener("click", ()=>{
                const layer = geoLayer.getLayers().find(l=>l.feature===it.f);
                if(layer){ map.fitBounds(layer.getBounds(),{padding:[20,20]}); layer.openPopup(); }
            });
            ol.appendChild(li);
        });
    })
    .catch(error => {
        console.error('Error loading GeoJSON:', error);
    });
</script>
</body>
</html>