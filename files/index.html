<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>China Housing Price Decline</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .note { padding:12px; background:#f9f9f9; border-left:4px solid #1976d2; 
            margin:10px; border-radius:6px; font-size:14px; line-height:1.5; }
    .tooltip { position: absolute; background: white; border: 1px solid #999;
               padding: 6px; border-radius: 4px; pointer-events: none; font-size: 13px; }
    .top10 { position: absolute; top: 100px; right: 10px; width: 260px; 
             background: #fff; border: 1px solid #ddd; border-radius: 8px; 
             padding: 10px; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    svg { width: 100%; height: 600px; }
  </style>
</head>
<body>

<div class="note">
  <p><strong>Note:</strong> The housing price data is based on the monthly average listing prices of second-hand homes from <em>Anjuke (安居客)</em>.</p>
  <p><strong>Definition of decline:</strong> The percentage drop is measured from each city’s peak price between 2010 and 2025 down to the value in July 2025.</p>
  <p><strong>Tip:</strong> Click a city block to view details including the city name, the year and value of the peak price, and the decline up to July 2025.</p>
</div>

<svg id="map"></svg>
<div class="top10" id="top10"><strong>Top 10 Cities by Decline</strong><ul></ul></div>
<div class="tooltip" id="tooltip" style="opacity:0"></div>

<script>
// === STEP 1: Projection and SVG ===
const width = 960, height = 600;
const svg = d3.select("#map")
    .attr("width", width)
    .attr("height", height);

const projection = d3.geoMercator()
    .center([104, 35])
    .scale(700)
    .translate([width / 2, height / 2]);

const path = d3.geoPath().projection(projection);

// === STEP 2: Load data ===
Promise.all([
  d3.json("files/china_simplified.geojson"),  // your simplified GeoJSON
  d3.csv("files/decline_data.csv")            // city decline data
]).then(([geojson, data]) => {
  let declineMap = {};
  data.forEach(d => {
    declineMap[d.city] = {
      decline: +d.decline,
      peakYear: d.peakYear,
      peakPrice: d.peakPrice
    };
  });

  geojson.features.forEach(f => {
    let city = f.properties.name;
    if (declineMap[city]) {
      f.properties.decline = declineMap[city].decline;
      f.properties.peakYear = declineMap[city].peakYear;
      f.properties.peakPrice = declineMap[city].peakPrice;
    } else {
      f.properties.decline = 0;
    }
  });

  // === STEP 3: Color scale ===
  let color = d3.scaleThreshold()
      .domain([10, 20, 30, 40, 50])   // thresholds
      .range(d3.schemeBlues[6]);      // 6 shades

  // === STEP 4: Tooltip ===
  const tooltip = d3.select("#tooltip");

  // === STEP 5: Draw map ===
  svg.selectAll("path")
    .data(geojson.features)
    .join("path")
    .attr("d", path)
    .attr("fill", d => d.properties.decline ? color(d.properties.decline) : "#ccc")
    .attr("stroke", "#333")
    .on("mouseover", function(event, d) {
      d3.select(this).attr("stroke-width", 2);
      tooltip.transition().duration(200).style("opacity", 1);
      tooltip.html(`
        <strong>${d.properties.name}</strong><br/>
        Peak Year: ${d.properties.peakYear || "N/A"}<br/>
        Peak Price: ${d.properties.peakPrice || "N/A"}<br/>
        Decline: ${d.properties.decline ? d.properties.decline.toFixed(1) + "%" : "N/A"}
      `)
      .style("left", (event.pageX+10)+"px")
      .style("top", (event.pageY-28)+"px");
    })
    .on("mouseout", function() {
      d3.select(this).attr("stroke-width", 1);
      tooltip.transition().duration(200).style("opacity", 0);
    });

  // === STEP 6: Legend ===
  const legend = d3.legendColor()
    .labelFormat(d3.format(".0f"))
    .labels(d3.legendHelpers.thresholdLabels)
    .scale(color)
    .title("Decline (%)");

  svg.append("g")
    .attr("transform", "translate(20,400)")
    .call(legend);

  // === STEP 7: Top 10 cities ===
  let top10 = geojson.features
    .filter(d => d.properties.decline)
    .sort((a,b) => d3.descending(a.properties.decline, b.properties.decline))
    .slice(0,10);

  let top10Box = d3.select("#top10 ul");
  top10Box.selectAll("li")
    .data(top10)
    .enter()
    .append("li")
    .text(d => `${d.properties.name}: ${d.properties.decline.toFixed(1)}%`);
});
</script>
</body>
</html>
