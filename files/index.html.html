
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>China Housing Price Decline</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; }

        .info-panel {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: #fff; padding: 14px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,.08); max-width: 320px;
        }
        .legend {
            position: absolute; bottom: 30px; right: 10px; z-index: 1000;
            background: #fff; padding: 12px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,.08);
        }
        .legend-item { display: flex; align-items: center; margin: 4px 0; font-size: 12px; }
        .legend-color { width: 20px; height: 15px; margin-right: 8px; border: 1px solid #ddd; }
        .stats { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3 style="margin: 0 0 10px 0;">China Housing Price Decline</h3>
        <div>
            <strong>Analysis Overview</strong><br/>
            <span id="dataStatus">Loading data‚Ä¶</span>
        </div>
        <div class="stats" id="statsPanel" style="display:none">
            <div id="averageDecline"></div>
            <div id="severeDeclines"></div>
            <div id="nearPeaks"></div>
        </div>
    </div>

    <div class="legend">
        <h4 style="margin: 0 0 10px 0;">Decline from Peak (%)</h4>
        <div class="legend-item"><div class="legend-color" style="background:#8B0000;"></div><span>New High (+5%)</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFE6E6;"></div><span>Near Peak (0%)</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFFFFF;"></div><span>-5% decline</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#E6F3FF;"></div><span>-10% decline</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#87CEEB;"></div><span>-15% decline</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#4169E1;"></div><span>-25% decline</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#000080;"></div><span>-40%+ decline</span></div>
    </div>

    <div id="map"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map, currentLayer, geojsonData = null;

        // Color mapping (updated: cap at -40%)
        function getColor(value) {
            if (typeof value !== 'number' || isNaN(value)) return '#CCCCCC';
            // Cap value at -40 (anything <= -40 shown as darkest blue)
            const v = Math.max(value, -40);
            if (v >= 5)   return '#8B0000';  // Dark red - new high
            if (v >= 0)   return '#FFE6E6';  // Light red - near peak
            if (v >= -5)  return '#FFFFFF';  // White - small decline
            if (v >= -10) return '#E6F3FF';  // Very light blue
            if (v >= -15) return '#87CEEB';  // Light blue
            if (v >= -25) return '#4169E1';  // Blue
            // v in [-40, -25)
            return '#000080';                // Dark blue -40% or more decline
        }

        function style(feature) {
            const p = feature.properties || {};
            const v = (typeof p.decline_from_peak_capped === 'number')
                        ? p.decline_from_peak_capped
                        : p.decline_from_peak;
            return {
                fillColor: getColor(v),
                weight: 0.2, opacity: 0.3, color: 'gray', fillOpacity: 0.9
            };
        }

        function onEachFeature(feature, layer) {
            const p = feature.properties || {};
            const decline = (typeof p.decline_from_peak === 'number') ? p.decline_from_peak : p.decline_from_peak_capped;
            const allYears = (geojsonData?.features || []).map(f => f.properties?.year).filter(v => typeof v === 'number');
            const currentYear = (allYears.length ? Math.max(...allYears) : new Date().getFullYear());

            layer.bindPopup(`
                <div style="font-family: Arial, sans-serif; line-height: 1.4;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">${p.city ?? 'Unknown'}</h4>
                    <strong>Province:</strong> ${p.pr_name ?? 'N/A'}<br/><br/>
                    <div style="background:#f5f5f5; padding:8px; border-radius:4px; margin:8px 0;">
                        <strong>üèÜ Peak Year: ${p.peak_year ?? 'N/A'}</strong><br/>
                        <small>Peak Price: ¬•${p.peak_price ? Math.round(p.peak_price).toLocaleString() : 'N/A'}/m¬≤</small>
                    </div>
                    <div style="background:#f0f8ff; padding:8px; border-radius:4px; margin:8px 0;">
                        <strong>üìÖ Current (${currentYear}):</strong><br/>
                        Current Price: ¬•${p.current_price ? Math.round(p.current_price).toLocaleString() : 'N/A'}/m¬≤<br/>
                        <strong style="color: ${(decline ?? 0) >= 0 ? '#d32f2f' : '#1976d2'};">
                            ${(decline ?? 0) >= 0 ? 'üìà' : 'üìâ'} ${(decline ?? 0).toFixed ? decline.toFixed(1) : decline}% from peak
                        </strong>
                    </div>
                    <small>‚è±Ô∏è ${p.years_since_peak ?? 'N/A'} years since peak ¬∑ üè¢ Tier: ${p.tier ?? 'N/A'}</small>
                </div>
            `, { maxWidth: 300 });
        }

        function calculateStats(data) {
            const declines = (data.features || []).map(f => {
                const p = f.properties || {};
                return (typeof p.decline_from_peak_capped === 'number') ? p.decline_from_peak_capped : p.decline_from_peak;
            }).filter(v => typeof v === 'number');

            if (!declines.length) return;

            const sum = declines.reduce((a,b)=>a+b, 0);
            const avgDecline = (sum / declines.length).toFixed(1);
            const severeCount = declines.filter(d => d <= -20).length;
            const nearPeakCount = declines.filter(d => d >= -5).length;

            document.getElementById('averageDecline').textContent = `Avg decline: ${avgDecline}%`;
            document.getElementById('severeDeclines').textContent = `Severe decline (>20%): ${severeCount} cities`;
            document.getElementById('nearPeaks').textContent = `Near peak (<5% decline): ${nearPeakCount} cities`;
            document.getElementById('statsPanel').style.display = '';
        }

        function initMap() {
            map = L.map('map').setView([35, 105], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            // Â¶ÇÊûú‰Ω†Êää index.html ÊîæÂú® /files/ ÁõÆÂΩïÈáåÂπ∂‰∏î‰πüÊää geojson ÊîæÂú® /files/ÔºåÂèØÁî®Áõ∏ÂØπË∑ØÂæÑ './peak_decline_boundaries_simplified.geojson'
            // Ëã• index.html ‰∏é .geojson Âú®Âêå‰∏ÄÁõÆÂΩïÔºåÁõ¥Êé•Áî®Êñá‰ª∂ÂêçÂç≥ÂèØ
            fetch('peak_decline_boundaries_simplified.geojson')
              .then(r => r.json())
              .then(data => {
                  geojsonData = data;
                  document.getElementById('dataStatus').textContent =
                      `Total Cities: ${data.features?.length ?? 0}`;
                  currentLayer = L.geoJSON(data, { style, onEachFeature }).addTo(map);
                  calculateStats(data);
                  const bounds = currentLayer.getBounds();
                  if (bounds.isValid()) map.fitBounds(bounds, { padding: [20,20] });
              })
              .catch(err => {
                  console.error(err);
                  document.getElementById('dataStatus').textContent = '‚ùå Failed to load data';
              });
        });
    </script>
</body>
</html>
